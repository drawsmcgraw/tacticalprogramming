<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Tactical Programming</title>
        <link rel="stylesheet" href="https://tacticalprogramming.com/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://tacticalprogramming.com/">Tactical Programming </a></h1>
                <nav><ul>
                    <li><a href="https://tacticalprogramming.com/category/howto.html">howto</a></li>
                    <li><a href="https://tacticalprogramming.com/category/philosophy.html">philosophy</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://tacticalprogramming.com/pivotal-cloud-foundry-and-vm-extensions-in-aws.html">Pivotal Cloud Foundry and VM Extensions in AWS</a></h1>
<footer class="post-info">
        <span>Tue 07 May 2019</span>

</footer><!-- /.post-info --><h1>Problem</h1>
<p>As of this writing, the docs for <a href="https://docs.pivotal.io/pivotalcf/2-5/customizing/aws-terraform.html">deploying PCF on Amazon using Terraform</a> have a gap that could lead to a lot of frustration. In short, the Terraform files and docs have switched to using Network Load Balancers instead of 'Classic', Elastic Load Balancers. The end result is there is a detail that we need to implement ourselves.</p>
<p>The problem is that our router vms need to be placed behind the <code>vms_security_group</code> in order to accept HTTP/HTTPS traffic. But how do we tell PCF (and therefore, Bosh) to make that association? We do it with the <code>vm_extension</code> feature.</p>
<h1>TL;DR</h1>
<p>You need to create three vm extensions and add them under the <code>resource-config</code> section for the <code>compute</code>, <code>router</code>, and <code>tcp_router</code> jobs in your product config (i.e. PAS or PKS).</p>
<p>For reference, see the engineering team's pipeline. Specifically <a href="https://github.com/pivotal-cf/terraforming-aws/blob/d4482bb733e34a7e3c4a48ef55f65610a91a57eb/ci/tasks/custom-vm-extensions.sh#L10">this shell script which makes the vm extensions</a> and <a href="https://github.com/pivotal-cf/terraforming-aws/blob/d4482bb733e34a7e3c4a48ef55f65610a91a57eb/ci/assets/template/srt-config.yml#L57">this sample PAS config template</a></p>
<h1>Solution, Detailed</h1>
<p>Follow the docs as usual to configure your product. But before deploying, SSH into your Ops Manager vm. You'll also need the <a href="https://github.com/pivotal-cf/om"><code>om</code></a> utility.</p>
<h2>Create the VM Extensions</h2>
<p>Set up <code>om</code> to auth to your Ops Manager:</p>
<div class="highlight"><pre><span></span>export OM_USERNAME=admin
export OM_PASSWORD=&#39;password&#39;
export OM_TARGET=https://localhost
</pre></div>


<p>Use <code>om</code> to create your three vm extensions. You can safely copy/paste the following code block.</p>
<div class="highlight"><pre><span></span>om -k curl --path /api/v0/staged/vm_extensions/web-lb-security-groups -x PUT -d \
  &#39;{&quot;name&quot;: &quot;web-lb-security-groups&quot;, &quot;cloud_properties&quot;: { &quot;security_groups&quot;: [&quot;web_lb_security_group&quot;, &quot;vms_security_group&quot;] }}&#39;

om -k curl --path /api/v0/staged/vm_extensions/ssh-lb-security-groups -x PUT -d \
  &#39;{&quot;name&quot;: &quot;ssh-lb-security-groups&quot;, &quot;cloud_properties&quot;: { &quot;security_groups&quot;: [&quot;ssh_lb_security_group&quot;, &quot;vms_security_group&quot;] }}&#39;

om -k curl --path /api/v0/staged/vm_extensions/tcp-lb-security-groups -x PUT -d \
  &#39;{&quot;name&quot;: &quot;tcp-lb-security-groups&quot;, &quot;cloud_properties&quot;: { &quot;security_groups&quot;: [&quot;tcp_lb_security_group&quot;, &quot;vms_security_group&quot;] }}&#39;
</pre></div>


<p>Onward to the config.</p>
<h2>Fetch the existing config</h2>
<p>Inspect your staged products (this is where you'll look for PAS or PKS):</p>
<div class="highlight"><pre><span></span>om -k staged-products
+--------+-----------------+
|  NAME  |     VERSION     |
+--------+-----------------+
| p-bosh | 2.5.2-build.172 |
| cf     | 2.5.2           |
+--------+-----------------+
</pre></div>


<p>In my case, I'm deploying PAS, so I care about the <code>cf</code> entry. Let's grab the current config:</p>
<div class="highlight"><pre><span></span>om -k staged-config --product-name cf &gt; srt-config.yml
</pre></div>


<h2>Update the config</h2>
<p>You'll need to update three things:</p>
<p>1) Update the <code>resource-config</code> portion to include the vm extensions you created. As an example, here's the stanza for the <code>router</code> section. Note the <code>additional_vm_extensions</code> addition.</p>
<div class="highlight"><pre><span></span>  router:
    instances: automatic
    instance_type:
      id: automatic
    internet_connected: false
    elb_names:
    - alb:pcf-web-tg-80
    - alb:pcf-web-tg-443
    additional_vm_extensions:
    - web-lb-security-groups
</pre></div>


<p>Do that for the <code>compute</code> and <code>tcp-router</code> sections as well. Be sure to put in the <em>correct</em> load balancer names (be wary of copy/paste errors).</p>
<p>2) Re-enter the CredHub key in the <code>credhub_key_encryption_passwords</code> section. Because reasons, some sensitive information doesn't survive the export. You need to put it back into the config file.</p>
<p>3) Re-enter the SSL cert/key in the <code>networking_poe_ssl_certs</code> section for the same reasons.</p>
<p>For reference, here's a diff of what the changes looked on my system after I was done updating them.</p>
<div class="highlight"><pre><span></span><span class="gd">--- srt-config.yml  2019-05-07 14:57:46.254487693 +0000</span>
<span class="gi">+++ srt-config.yml.updated.yml  2019-05-07 15:16:08.187072002 +0000</span>
<span class="gu">@@ -109,8 +109,10 @@</span>
     selected_option: internal_mysql
     value: internal_mysql
   .properties.credhub_key_encryption_passwords:
<span class="gd">-    value:</span>
<span class="gd">-    - name: key</span>
<span class="gi">+    value: </span>
<span class="gi">+    - key: </span>
<span class="gi">+        secret: randomstringthatisatleasttwentydigits</span>
<span class="gi">+      name: key</span>
       primary: true
       provider: internal
   .properties.diego_database_max_open_connections:
<span class="gu">@@ -160,7 +162,61 @@</span>
     value: connect,query
   .properties.networking_poe_ssl_certs:
     value:
<span class="gd">-    - name: pcf</span>
<span class="gi">+    - certificate:</span>
<span class="gi">+        cert_pem: |</span>
<span class="gi">+          -----BEGIN CERTIFICATE-----</span>
<span class="gi">+          CERT STUFFS</span>
<span class="gi">+          -----END CERTIFICATE-----</span>
<span class="gi">+        private_key_pem: |</span>
<span class="gi">+          -----BEGIN RSA PRIVATE KEY-----</span>
<span class="gi">+          KEY STUFFS</span>
<span class="gi">+          -----END RSA PRIVATE KEY-----</span>
<span class="gi">+      name: pcf</span>
   .properties.networkpolicyserver_database_max_open_connections:
     value: 200
   .properties.networkpolicyserverinternal_database_max_open_connections:
<span class="gu">@@ -338,6 +394,8 @@</span>
     internet_connected: false
     elb_names:
     - alb:pcf-ssh-tg
<span class="gi">+    additional_vm_extensions:</span>
<span class="gi">+    - ssh-lb-security-groups</span>
   database:
     instances: automatic
     persistent_disk:
<span class="gu">@@ -378,6 +436,8 @@</span>
     elb_names:
     - alb:pcf-web-tg-80
     - alb:pcf-web-tg-443
<span class="gi">+    additional_vm_extensions:</span>
<span class="gi">+    - web-lb-security-groups</span>
   tcp_router:
     instances: automatic
     persistent_disk:
<span class="gu">@@ -396,6 +456,8 @@</span>
     - alb:pcf-tg-1031
     - alb:pcf-tg-1032
     - alb:pcf-tg-1033
<span class="gi">+    additional_vm_extensions:</span>
<span class="gi">+    - tcp-lb-security-groups</span>
 errand-config:
   deploy-autoscaler:
     post-deploy-state: true
</pre></div>


<p>As a reminder, you can use the templated PAS config (linked above) as a reference when you update your config.</p>
<h2>Upload the Config</h2>
<p>Here's what a successful update looks like:</p>
<div class="highlight"><pre><span></span>./om -k configure-product -c srt-config.yml.updated.yml 
configuring product...
setting up network
finished setting up network
setting properties
finished setting properties
applying resource configuration for the following jobs:
    backup_restore
    blobstore
    compute
    control
    database
    ha_proxy
    istio_control
    istio_router
    mysql_monitor
    route_syncer
    router
    tcp_router
applying errand configuration for the following errands:
    deploy-autoscaler
    deploy-notifications
    deploy-notifications-ui
    metric_registrar_smoke_test
    nfsbrokerpush
    push-apps-manager
    push-usage-service
    smbbrokerpush
    smoke_tests
    test-autoscaling
finished configuring product
</pre></div>


<p>The system will tell you if there are errors in your configuration. Consider a successful upload to be a valid config.</p>
<p>Except...</p>
<h2>Enter the CredHub Key One More Time</h2>
<p>For reasons I don't understand yet, the product deployment will fail because the credhub key gets mangled somehow. The error I saw was <code>Details: undefined method 'length' for 1.2345678910111213e+30:Float</code>.</p>
<p>To fix this, re-enter the key in the Ops Manager UI.</p>
<p>You may now continue with your deployment as normal. When your vms get created, the router vms will be placed behind the <code>vms_security_group</code>, which allows your HTTP/HTTPS traffic through.</p>
<h2>Last Thoughts</h2>
<p>This really is the ugly, mnaual way of doing it. A more 'correct' way of doing this would be using the Ops Manager api to update the job config for your product to include the vm extensions. That journey begins with <a href="https://docs.pivotal.io/pivotalcf/2-5/opsman-api/?shell#configuring-resources-for-a-job-experimental">the API docs for managing vm extensions</a>. </p>
<p>You would still be using <code>om</code> to create the vm extensions, but you wouldn't have to pull down, update, and push back the product configuration. My hope is to come up with that cleaner method and follow up on that topic here. Eventually.</p>
<p>For now, consider yourself unstuck, even if it's a little ugly.</p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="https://tacticalprogramming.com/creating-small-local-offline-apt-repos.html" rel="bookmark"
                           title="Permalink to Creating Small Local Offline Apt Repos">Creating Small Local Offline Apt Repos</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Thu 17 January 2019</span>

</footer><!-- /.post-info -->                <h1>Problem</h1>
<p>We have an offline (i.e. airgapped) Ubuntu machine (or machines) and the need to install packages on them. We also are unable to stand up our own repo mirror (because <em>reasons</em>), so all we have is our single machine with limited disk space.</p>
<h1>Solution</h1>
<p>Package up only the …</p>
                <a class="readmore" href="https://tacticalprogramming.com/creating-small-local-offline-apt-repos.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://tacticalprogramming.com/another-certificate-request-post-with-san-action.html" rel="bookmark"
                           title="Permalink to Another Certificate Request Post with SAN Action">Another Certificate Request Post with SAN Action</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Wed 17 October 2018</span>

</footer><!-- /.post-info -->                <h1>Problem</h1>
<p>We need to make several Certificate Signing Requests (CSRs) for our datacenter. Two, or two-thousand, it doesn't matter. We're putting together a one-liner that will solve it for us. Of course we're automating it.</p>
<h1>Solution</h1>
<p>Create a text file containing your server short names. Say, <code>servers.txt</code>.</p>
<div class="highlight"><pre><span></span>salt-master-01
es-data-01 …</pre></div>
                <a class="readmore" href="https://tacticalprogramming.com/another-certificate-request-post-with-san-action.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://tacticalprogramming.com/simple-bash-expansion.html" rel="bookmark"
                           title="Permalink to Simple Bash Expansion">Simple Bash Expansion</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Fri 05 October 2018</span>

</footer><!-- /.post-info -->                <p>In keeping with <a href="https://tacticalprogramming.com/invest-in-the-fundamentals.html">the fundamentals</a>, here's a handy one-liner to save yourself a few extra commands.</p>
<h1>Problem</h1>
<p>We want to delete a number of machines via Salt Cloud, but we want it in a one-liner because we hate typing the same thing over and over.</p>
<div class="highlight"><pre><span></span>$ salt-key
Accepted Keys:
esdata-01
esdata-02 …</pre></div>
                <a class="readmore" href="https://tacticalprogramming.com/simple-bash-expansion.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://tacticalprogramming.com/saltstack-and-dnsmasq-for-easy-predictable-network-space-management.html" rel="bookmark"
                           title="Permalink to Saltstack and Dnsmasq for Easy, Predictable Network Space Management">Saltstack and Dnsmasq for Easy, Predictable Network Space Management</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Thu 04 October 2018</span>

</footer><!-- /.post-info -->                <h1>Introduction</h1>
<p>Salt has moved on from simple configuration management and is better described as "event-driven automation". At the heart of this argument is the message bus.</p>
<p>A typical follow up to <a href="https://tacticalprogramming.com/saltstack-and-vmware-deploying-vms-from-templates.html">getting your hands around your internal cloud</a> is going to be management of your network space. Let's go through …</p>
                <a class="readmore" href="https://tacticalprogramming.com/saltstack-and-dnsmasq-for-easy-predictable-network-space-management.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://tacticalprogramming.com/saltstack-and-vmware-deploying-vms-from-templates.html" rel="bookmark"
                           title="Permalink to Saltstack and VMWare - Deploying VMs from Templates">Saltstack and VMWare - Deploying VMs from Templates</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Wed 19 September 2018</span>

</footer><!-- /.post-info -->                <p>It turns out that there are a lot of nuances when using Saltstack with VMWare. Let's walk through the requirements for successfully using Saltstack to deploy VMs on VMWare. </p>
<h1>Assumptions</h1>
<p>To narrow the scope of this post, we'll assume the following is already taken care of.</p>
<ul>
<li>The intended use is …</li></ul>
                <a class="readmore" href="https://tacticalprogramming.com/saltstack-and-vmware-deploying-vms-from-templates.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://tacticalprogramming.com/on-presumptive-software.html" rel="bookmark"
                           title="Permalink to On Presumptive Software">On Presumptive Software</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Thu 30 August 2018</span>

</footer><!-- /.post-info -->                <p>If there's one thing that the great <a href="https://blog.codinghorror.com/">Saint Atwood</a> taught me, it's this - software is built to help people do their jobs. That's why we have automation, right? Because we need something done and would rather not spend all our time manually building something. That's why we have software, computers …</p>
                <a class="readmore" href="https://tacticalprogramming.com/on-presumptive-software.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://tacticalprogramming.com/saltstacks-python-api-an-introduction.html" rel="bookmark"
                           title="Permalink to Saltstack's Python API - An Introduction">Saltstack's Python API - An Introduction</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Mon 20 August 2018</span>

</footer><!-- /.post-info -->                <p>I've always said that Salt is not configuration management. I want to expand on one of the capabilities that Salt, as a platform, can offer you. That capability lies just under all the <code>salt</code> commands you're accustomed to firing on the command line. It's Salt's <a href="https://docs.saltstack.com/en/latest/ref/clients">Python API</a>, not to be …</p>
                <a class="readmore" href="https://tacticalprogramming.com/saltstacks-python-api-an-introduction.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://tacticalprogramming.com/adding-virtual-disks-in-kvm.html" rel="bookmark"
                           title="Permalink to Adding Virtual Disks in KVM">Adding Virtual Disks in KVM</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Tue 03 July 2018</span>

</footer><!-- /.post-info -->                <p>Sometimes you need to make a few VMs. For me, it's usually libvirt.</p>
<p>We have some scripting around the creation of a number of machines, but what we don't have (yet) is the ability to add additional disks to those VMs. So instead of chasing each machine in the VM …</p>
                <a class="readmore" href="https://tacticalprogramming.com/adding-virtual-disks-in-kvm.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://tacticalprogramming.com/invest-in-the-fundamentals.html" rel="bookmark"
                           title="Permalink to Invest in the Fundamentals">Invest in the Fundamentals</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <span>Mon 18 June 2018</span>

</footer><!-- /.post-info -->                <h3><em>If you want to be useful, learn a trade</em></h3>
<p>In trying to keep up with the latest in technology and staying relevant, it's easy to forget that each one of these emerging technologies is built upon a bedrock of simple, reliable tools. Simple tools that you can learn, and then …</p>
                <a class="readmore" href="https://tacticalprogramming.com/invest-in-the-fundamentals.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
            </ol><!-- /#posts-list -->
<p class="paginator">
    Page 1 / 1
</p>
            </section><!-- /#content -->
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-126652865-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>